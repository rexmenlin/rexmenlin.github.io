"use strict";(self.webpackChunkcodetenshu=self.webpackChunkcodetenshu||[]).push([[2860],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>y});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),s=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=s(e.components);return a.createElement(i.Provider,{value:t},e.children)},u="mdxType",k={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,d=p(e,["components","mdxType","originalType","parentName"]),u=s(n),c=r,y=u["".concat(i,".").concat(c)]||u[c]||k[c]||o;return n?a.createElement(y,l(l({ref:t},d),{},{components:n})):a.createElement(y,l({ref:t},d))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=c;var p={};for(var i in t)hasOwnProperty.call(t,i)&&(p[i]=t[i]);p.originalType=e,p[u]="string"==typeof e?e:r,l[1]=p;for(var s=2;s<o;s++)l[s]=n[s];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},6296:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>p,toc:()=>s});var a=n(7462),r=(n(7294),n(3905));const o={sidebar_position:24},l=void 0,p={unversionedId:"finance-bank-api/Day23 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58834 - \u4fe1\u7528\u5361\u5237\u5361\u7d50\u679c",id:"finance-bank-api/Day23 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58834 - \u4fe1\u7528\u5361\u5237\u5361\u7d50\u679c",title:"Day23 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58834 - \u4fe1\u7528\u5361\u5237\u5361\u7d50\u679c",description:"\u6628\u5929\u5beb\u5b8c\u5169\u7a2e\u4ed8\u6b3e\u65b9\u5f0f\uff0c\u6709\u63d0\u5230\u539f\u5148\u4fe1\u7528\u5361\u5237\u5361\u5f8c\u7684\u7d50\u679c\u5c0e\u56de\u9801ReturnURL\u6211\u5011\u9084\u6c92\u5be6\u4f5c\uff0c\u4eca\u5929\u5c31\u628a\u9019\u4e00\u9801\u5b8c\u6210\u3002",source:"@site/docs/finance-bank-api/Day23 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58834 - \u4fe1\u7528\u5361\u5237\u5361\u7d50\u679c.md",sourceDirName:"finance-bank-api",slug:"/finance-bank-api/Day23 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58834 - \u4fe1\u7528\u5361\u5237\u5361\u7d50\u679c",permalink:"/docs/finance-bank-api/Day23 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58834 - \u4fe1\u7528\u5361\u5237\u5361\u7d50\u679c",draft:!1,tags:[],version:"current",sidebarPosition:24,frontMatter:{sidebar_position:24},sidebar:"tutorialSidebar",previous:{title:"Day22 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58833 - \u5169\u7a2e\u4ed8\u6b3e\u65b9\u5f0f\u5be6\u4f5c",permalink:"/docs/finance-bank-api/Day22 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58833 - \u5169\u7a2e\u4ed8\u6b3e\u65b9\u5f0f\u5be6\u4f5c"},next:{title:"Day24 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58835 - \u6211\u7684\u8a02\u55ae",permalink:"/docs/finance-bank-api/Day24 - \u4ee5Django Web\u6846\u67b6\u5be6\u4f5c\u6c38\u8c50API\u7dda\u4e0a\u652f\u4ed8\u6a21\u64ec\u60c5\u58835 - \u6211\u7684\u8a02\u55ae"}},i={},s=[{value:"\u6d41\u7a0b\u8aaa\u660e",id:"\u6d41\u7a0b\u8aaa\u660e",level:3},{value:"View\u7684card_return\u4fee\u6539",id:"view\u7684card_return\u4fee\u6539",level:3},{value:"\u7a0b\u5f0f\u8aaa\u660e",id:"\u7a0b\u5f0f\u8aaa\u660e",level:5},{value:"Model\u4e2d\u7684<code>update_order_by_paytoken()</code>\u4fee\u6539",id:"model\u4e2d\u7684update_order_by_paytoken\u4fee\u6539",level:3},{value:"\u7a0b\u5f0f\u8aaa\u660e",id:"\u7a0b\u5f0f\u8aaa\u660e-1",level:5},{value:"\u53ef\u4ee5\u4f86\u770bTemplate\u4e86",id:"\u53ef\u4ee5\u4f86\u770btemplate\u4e86",level:3},{value:"\u7a0b\u5f0f\u8aaa\u660e",id:"\u7a0b\u5f0f\u8aaa\u660e-2",level:5},{value:"\u6d41\u7a0b\u8aaa\u660e",id:"\u6d41\u7a0b\u8aaa\u660e-1",level:3},{value:"View\u7684card_return\u4fee\u6539",id:"view\u7684card_return\u4fee\u6539-1",level:3},{value:"\u7a0b\u5f0f\u8aaa\u660e",id:"\u7a0b\u5f0f\u8aaa\u660e-3",level:5},{value:"Model\u4e2d\u7684<code>update_order_by_paytoken()</code>\u4fee\u6539",id:"model\u4e2d\u7684update_order_by_paytoken\u4fee\u6539-1",level:3},{value:"\u7a0b\u5f0f\u8aaa\u660e",id:"\u7a0b\u5f0f\u8aaa\u660e-4",level:5},{value:"\u53ef\u4ee5\u4f86\u770bTemplate\u4e86",id:"\u53ef\u4ee5\u4f86\u770btemplate\u4e86-1",level:3},{value:"\u7a0b\u5f0f\u8aaa\u660e",id:"\u7a0b\u5f0f\u8aaa\u660e-5",level:5},{value:"\u53ea\u6709\u62ff\u5230PayToken\u9019\u9ebc\u7c21\u55ae\u55ce",id:"\u53ea\u6709\u62ff\u5230paytoken\u9019\u9ebc\u7c21\u55ae\u55ce",level:3},{value:"STEP1\uff1a \u958b\u500b\u7db2\u5740\u63a5\u53e3\u4f86\u8655\u7406PayToken",id:"step1-\u958b\u500b\u7db2\u5740\u63a5\u53e3\u4f86\u8655\u7406paytoken",level:4},{value:"STEP2\uff1a \u67e5\u8a62\u9867\u5ba2\u4ed8\u6b3e\u72c0\u614b",id:"step2-\u67e5\u8a62\u9867\u5ba2\u4ed8\u6b3e\u72c0\u614b",level:4},{value:"\u7d00\u9304\u88abAPI\u56de\u547c\u7d00\u9304",id:"\u7d00\u9304\u88abapi\u56de\u547c\u7d00\u9304",level:4}],d={toc:s};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"\u6628\u5929\u5beb\u5b8c\u5169\u7a2e\u4ed8\u6b3e\u65b9\u5f0f\uff0c\u6709\u63d0\u5230\u539f\u5148\u4fe1\u7528\u5361\u5237\u5361\u5f8c\u7684\u7d50\u679c\u5c0e\u56de\u9801",(0,r.kt)("inlineCode",{parentName:"p"},"ReturnURL"),"\u6211\u5011\u9084\u6c92\u5be6\u4f5c\uff0c\u4eca\u5929\u5c31\u628a\u9019\u4e00\u9801\u5b8c\u6210\u3002"),(0,r.kt)("p",null,"\u5148\u8aaa\u660e\u4e00\u4e0b\uff0c\u4fe1\u7528\u5361\u5237\u5361\u6642\uff0c\u4e0d\u6703\u7acb\u5373\u5f97\u5230\u7d50\u679c\uff0c\u6703\u900f\u904e\u6211\u5011\u5728\u5efa\u7acb\u8a02\u55ae\u6642\u50b3\u5165\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"ReturnURL"),"\u53c3\u6578\uff0c\u5f85\u8f49\u5165\u6c38\u8c50\u7dda\u4e0a\u5237\u5361\u9801\u9762\u5f8c\uff0c\u6703\u518d\u900f\u904e\u9019\u500b\u7db2\u5740\u5c0e\u56de\u6211\u5011\u7684\u96fb\u5546\u7d50\u679c\u9801\u3002\u7d30\u90e8\u6d41\u7a0b\u5982\u4e0b"),(0,r.kt)("h3",{id:"\u6d41\u7a0b\u8aaa\u660e"},"\u6d41\u7a0b\u8aaa\u660e"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"[\u96fb\u5546]"," \u547c\u53eb\u6c38\u8c50API\uff0c\u5efa\u7acb\u4fe1\u7528\u5361\u4ed8\u6b3e\u65b9\u5f0f\u7684\u8a02\u55ae\uff0c\u5f9eresponse\u53d6\u56de",(0,r.kt)("inlineCode",{parentName:"li"},"card_pay_url"),"\u7d50\u679c\uff0c\u6211\u5011\u5c07\u9867\u5ba2\u5c0e\u5230\u9019\u500b\u7db2\u5740\u53bb\u5237\u5361"),(0,r.kt)("li",{parentName:"ol"},"[\u6c38\u8c50]"," \u5728\u6c38\u8c50\u7684\u7db2\u9801\u9032\u884c\u5237\u5361\uff0c\u56e0\u6b64\u4f7f\u7528\u8005\u7684\u4fe1\u7528\u5361\u6a5f\u654f\u8cc7\u8a0a\u4e0d\u6703\u7559\u5728\u96fb\u5546\u5e73\u53f0\u4e0a"),(0,r.kt)("li",{parentName:"ol"},"[\u6c38\u8c50]"," \u9032\u884c\u4fe1\u7528\u5361\u5237\u5361\u8655\u7406\uff0c\u5148\u7121\u8ad6\u7d50\u679c\uff0c\u5b8c\u6210\u5f8c\u6703\u5c07PayToken\u503c\u50b3\u5165",(0,r.kt)("inlineCode",{parentName:"li"},"ReturnURL"),"\u4e2d"),(0,r.kt)("li",{parentName:"ol"},"[\u96fb\u5546]"," \u9019\u6642\u5019\u6703\u900f\u904eReturnURL\u5c07",(0,r.kt)("inlineCode",{parentName:"li"},"PayToken"),"\u503c\u5e36\u56de\uff0c\u6211\u5011\u5c07\u6b64\u503c\u53d6\u51fa"),(0,r.kt)("li",{parentName:"ol"},"[\u96fb\u5546]"," \u4ee5",(0,r.kt)("inlineCode",{parentName:"li"},"PayToken"),"\u547c\u53eb\u6c38\u8c50API",(0,r.kt)("inlineCode",{parentName:"li"},"\u8a0a\u606f\u67e5\u8a62\u670d\u52d9(OrderPayQuery)")),(0,r.kt)("li",{parentName:"ol"},"[\u6c38\u8c50]"," \u56de\u50b3\u4ed8\u6b3e\u72c0\u614b\u76f8\u95dc\u8cc7\u8a0a"),(0,r.kt)("li",{parentName:"ol"},"[\u96fb\u5546]"," \u5c07\u4ed8\u6b3e\u72c0\u614b\u7d50\u679c\u986f\u793a\u65bc\u9801\u9762\u4e0a\uff0c\u6703\u5206\u5225\u986f\u793a\u5237\u5361\u6210\u529f\u4ee5\u53ca\u5237\u5361\u5931\u6557\u4e0d\u540c\u72c0\u614b\u7684\u8cc7\u8a0a\uff0c\u82e5\u5237\u5361\u5931\u6557\u6211\u5011\u53ef\u518d\u63d0\u4f9b\u4e00\u6b21\u5237\u5361\u9023\u7d50\u679c\u9867\u5ba2")),(0,r.kt)("h3",{id:"view\u7684card_return\u4fee\u6539"},"View\u7684card_return\u4fee\u6539"),(0,r.kt)("p",null,"\u5148\u524d\u6211\u5011\u6709\u5beb\u904eView\u4e2d\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"card_return()"),"\uff0c\u7576\u6642\u53ea\u9a57\u8b49\u4e00\u4e9b\u8cc7\u8a0a\u5f80\u4f86\u6b63\u4e0d\u6b63\u78ba\uff0c\u73fe\u5728\u8981\u4f5c\u4e00\u4e9b\u5c0f\u8abf\u6574\uff0c\u4f46\u5e45\u5ea6\u4e0d\u5927\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'def card_return(request):\n    pay_token_dic = {"PayToken": request.POST.get("PayToken"), "ShopNo": request.POST.get("ShopNo")}\n    create_new_paytoken(pay_token_dic["PayToken"])\n    result = update_order_by_paytoken(pay_token_dic)\n    return render(request, \'order/card_return.html\', result)\n')),(0,r.kt)("h5",{id:"\u7a0b\u5f0f\u8aaa\u660e"},"\u7a0b\u5f0f\u8aaa\u660e"),(0,r.kt)("p",null,"\u4e3b\u8981\u662f\u7576\u521d\u6211\u5011\u547c\u53eb",(0,r.kt)("inlineCode",{parentName:"p"},"update_order_by_paytoken()"),"\u6642\uff0c\u6c92\u6709\u56de\u50b3\u503c\uff0c\u6211\u5011\u5e0c\u671b\u628a\u6574\u7406\u904e\u5fc5\u8981\u7684\u8cc7\u8a0a\u56de\u50b3\u503c\u62ff\u56de\u4f86\uff0c\u5728\u7b49\u4e00\u4e0b\u7684Template\u4e2d\u4f5c\u70ba\u5224\u65b7\u4ee5\u53ca\u986f\u793a\u76f8\u95dc\u7d50\u679c\u7684\u8a0a\u606f"),(0,r.kt)("p",null,"\u800c\u53e6\u5916\u6211\u5011\u628a\u7576\u521d\u7684HttpResponse\u6539\u6210\u4e86render\u65b9\u5f0f\u5c0e\u5f15\u5230\u65b0\u6e96\u5099\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"order/card_return.html"),"\u4e2d\u3002"),(0,r.kt)("h3",{id:"model\u4e2d\u7684update_order_by_paytoken\u4fee\u6539"},"Model\u4e2d\u7684",(0,r.kt)("inlineCode",{parentName:"h3"},"update_order_by_paytoken()"),"\u4fee\u6539"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'def update_order_by_paytoken(paytoken_json):\n    result = {}\n    if paytoken_json:\n        pay_token = paytoken_json["PayToken"]\n        create_new_paytoken(pay_token)\n\n        paytoken_api = QueryByPaytokenMessage()\n        paytoken_api.set_paytoken_json(paytoken_json)\n        resp = ResponsePayToken(paytoken_api.send_query(), paytoken_api.hash_id)\n        print("-- Response: " + str(resp.dec_resp_json))\n\n        order = Payment.objects.get(order_no=resp.orderno)\n        order.pay_status = resp.status\n        order.pay_token = pay_token\n        order.lm_time = datetime.now()\n        order.save()\n\n        result["order_no"] = order.order_no\n        result["status_code"] = order.pay_status\n        if order.pay_status == "S":\n            result["pay_status"] = "\u5237\u5361\u6210\u529f"\n        else:\n            result["pay_status"] = "\u5237\u5361\u5931\u6557"\n        result["card_pay_url"] = order.card_pay_url\n\n        print(" Update Order Successfully.")\n    else:\n        print(" Update Order Fail.")\n    return result\n')),(0,r.kt)("h5",{id:"\u7a0b\u5f0f\u8aaa\u660e-1"},"\u7a0b\u5f0f\u8aaa\u660e"),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"update_order_by_paytoken()"),"\u4e2d\uff0c\u6211\u5011\u4e3b\u8981\u6e96\u5099\u4e86\u4e00\u500b",(0,r.kt)("inlineCode",{parentName:"p"},"result"),"\u4f5c\u70ba\u56de\u50b3\uff0c\u628a\u6240\u9700\u8981\u7684\u5fc5\u8981\u8cc7\u8a0a\u6574\u7406\u6210dictionary\u56de\u50b3\u56de\u53bb\uff0c\u5728\u9019\u88e1\u9806\u4fbf\u628a",(0,r.kt)("inlineCode",{parentName:"p"},"pay_status"),"\u4e2d\u7684\u4ee3\u78bc\u63db\u6210\u4e86\u53ef\u95b1\u8b80\u7684\u986f\u793a\u6587\u5b57\u3002"),(0,r.kt)("p",null,"\u4e0d\u904e\u6211\u5fc5\u9808\u518d\u4e09\u5f37\u8abf\uff0c\u9019\u6a23\u7684\u5beb\u6cd5\u4e26\u975e\u7522\u54c1\u7b49\u7d1a\u7684\u64b0\u5beb\u65b9\u6cd5\uff0c\u9019\u4e5f\u4e0d\u662f\u5728\u9019\u7cfb\u5217\u6587\u7ae0\u4e2d\u6211\u6253\u7b97\u5be6\u4f5c\u7684\uff0c\u90a3\u6a23\u53ea\u6703\u5c0d\u4e3b\u8981\u8981\u4ecb\u7d39\u6c38\u8c50API\u7684\u4e32\u63a5\u5931\u7126\u4e86\u3002\u4f46\u6211\u5011\u53ef\u4ee5\u8ac7\u4e00\u8ac7\u53ef\u4ee5\u600e\u9ebc\u505a\u6703\u6bd4\u8f03\u597d\u3002"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5728Model\u88e1\u9762\u5373\u4f7f\u4f7f\u7528\u4e86\u539f\u672c\u4ee3\u78bc\u8981\u8f49\u6210\u53ef\u95b1\u8b80\u6587\u5b57\uff0c\u4e26\u4e0d\u6703\u76f4\u63a5\u9019\u6a23\u8655\u7406\uff0c\u7121\u8ad6\u4f60\u7684\u7db2\u7ad9\u4e00\u958b\u59cb\u662f\u4e0d\u662f\u55ae\u4e00\u8a9e\u8a00\uff0c\u9019\u7a2e\u6700\u7d42\u8981\u986f\u793a\u5728UI\u4e0a\u7684\u6587\u5b57\uff0c\u4e0d\u6703\u5728Model\u88e1\u76f4\u63a5\u66ff\u63db\uff0c\u81f3\u5c11\u9700\u8003\u91cf\u5230i18n\u591a\u570b\u8a9e\u7cfb\u3002"),(0,r.kt)("li",{parentName:"ol"},"\u5373\u4f7f\u6c92\u6709\u8981\u505a\u591a\u570b\u8a9e\u7cfb\uff0c\u9019\u6a23\u7684UI\u6587\u5b57\u66ff\u63db\uff0c\u4e5f\u4e0d\u6703\u5728\u8655\u7406\u5c08\u8077\u529f\u80fd\u7684\u5546\u696d\u908f\u8f2f\u4e2d\u5be6\u4f5c\uff0c\u597d\u4e00\u9ede\u7684\u65b9\u5f0f\u6703\u5beb\u5728\u56de\u50b3\u4e4b\u5f8c\uff0c\u518d\u547c\u53eb\u53e6\u4e00\u500b\u5c08\u9580\u8655\u7406\u4ee3\u78bc\u8f49\u6587\u5b57\u7684Converter\u908f\u8f2f\u3002"),(0,r.kt)("li",{parentName:"ol"},'\u4e0a\u9762\u9019\u500bConverter\uff0c\u53e6\u4e00\u500b\u547c\u53eb\u968e\u6bb5\u53ef\u64fa\u5728View\u7684\u90a3\u5c64\u4f86\u8655\u7406(\u6211\u8aaa\u7684\u662fView\uff0c\u4e0d\u662fTemplate)\uff0c\u4f46\u4e0d\u662f\u5728View\u5c64\u76f4\u63a5\u4f5c\u4ee3\u78bc\u8f49\u6587\u5b57\uff0c\u800c\u662f\u5728View\u90a3\u5c64"\u518d\u547c\u53eb\u8655\u7406\u8f49\u63db\u7684\u908f\u8f2f"\uff0c\u7562\u7adf\u9019\u500b\u6700\u7d42\u7684\u5167\u5bb9\u662f\u5c6c\u65bc\u504fUI\u7684\u5167\u5bb9\u3002')),(0,r.kt)("p",null,"\u4f46\u70ba\u4e86\u7bc4\u4f8b\u65b9\u4fbf\uff0c\u6211\u5011\u5c31\u76f4\u63a5\u5728Model\u88e1\u8655\u7406\u6389\u4e86\uff0c\u4f46\u9019\u7d55\u5c0d\u4e0d\u662f\u6700\u597d\u7684\u4f5c\u6cd5\u3002"),(0,r.kt)("h3",{id:"\u53ef\u4ee5\u4f86\u770btemplate\u4e86"},"\u53ef\u4ee5\u4f86\u770bTemplate\u4e86"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'{% extends "base.html" %}\n\n{% block title %}{{ title }}{% endblock %}\n\n{% block body %}\n<div id="app" class="row g-3 align-self-center">\n<h1 class="display-4 text-center  mb-3 mt-5">\u4fe1\u7528\u5361\u5237\u5361\u7d50\u679c</h1>\n<p class="lead  text-center">\u611f\u8b1d\u60a8\u4f7f\u7528\u6c38\u8c50\u7dda\u4e0a\u4fe1\u7528\u5361\u5237\u5361\u670d\u52d9\uff0c\u4ee5\u4e0b\u662f\u60a8\u7684\u5237\u5361\u7d50\u679c\u5594\uff01</p>\n<hr/>\n<div class="container-fluid">\n    <h3 class="mb-5">\n      \u8a02\u55ae\u865f\u78bc <small class="text-muted">{{ order_no }}</small>\n    </h3>\n    <div class="border border-secondary rounded m-2 {% if status_code == \'S\' %}bg-success{% else %}bg-danger{% endif %}\n    text-white p-3">\n        <h6>\u60a8\u7684\u5237\u5361\u7d50\u679c</h6>\n        <p>\n            <span class="primary fs-4">{{ pay_status }}</span>\n        </p>\n        {% if status_code != \'S\' %}\n            <a href="{{ card_pay_url }}" class="btn btn-light btn-lg" tabindex="-1" role="button" aria-disabled="true">\u518d\u6b21\u4f7f\u7528\u6c38\u8c50\u4fe1\u7528\u5361\u5237\u5361</a>\n        {% endif %}\n\n    </div>\n    <br/><br/><br/><br/>\n    <hr/>\n    <div class="row mt-3">\n        <div class="col text-center">\n            <a href="{% url \'order_create_entrance\' %}" class="btn btn-primary btn-lg" tabindex="-1" role="button" aria-disabled="true">\u7e7c\u7e8c\u8cfc\u8cb7</a>\n            &nbsp\n            <a href="{% url \'my_orders\' %}" class="btn btn-secondary btn-lg" tabindex="-1" role="button" aria-disabled="true">\u56de\u5230\u8a02\u55ae</a>\n        </div>\n    </div>\n</div>\n</div>\n{% endblock %}\n\n{% block script %}\n{% endblock %}\n')),(0,r.kt)("h5",{id:"\u7a0b\u5f0f\u8aaa\u660e-2"},"\u7a0b\u5f0f\u8aaa\u660e"),(0,r.kt)("p",null,"\u5237\u5361\u7d50\u679c\u7576\u7136\u5c31\u76f4\u63a5\u628a\u525b\u525b\u4e0a\u9762\u8ac7\u534a\u5929\u7684",(0,r.kt)("strong",{parentName:"p"},"\u5237\u5361\u7d50\u679c\u7684UI\u6587\u5b57"),"\u76f4\u63a5\u4ee5",(0,r.kt)("inlineCode",{parentName:"p"},"{{ pay_status }}"),"\u986f\u793a\u51fa\u4f86\u3002\u4f46\u6211\u5011\u5e0c\u671b\u5728\u7d50\u679c\u7684\u4e8c\u5206\u4e16\u754c\u4e2d\uff0c\u4ee5\u984f\u8272\u4f86\u4f5c\u660e\u986f\u7684\u5340\u9694\uff0c\u56e0\u6b64\u5c31\u53ef\u4ee5\u62ff",(0,r.kt)("inlineCode",{parentName:"p"},"status_code"),"\u7d50\u679c\u4ee3\u78bc\u5c0d\u5237\u5361\u6210\u529f\u6216\u5931\u6557\u6539\u8b8a\u984f\u8272\uff0c\u9019\u88e1\u900f\u904eBootstrap\u7684\u57fa\u672c\u5e7e\u500b\u8272\u8abf\u4f86\u8abf\u6574div\u7684\u80cc\u666f\u984f\u8272\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u6210\u529f\uff1abg-success"),(0,r.kt)("li",{parentName:"ul"},"\u5931\u6557\uff1abg-danger")),(0,r.kt)("p",null,"\u7136\u5f8c\u5728\u5931\u6557\u7684\u6642\u5019\uff0c\u518d\u6b21\u5c07\u5237\u5361\u7db2\u5740\u6309\u9215\u9644\u4e0a\uff0c\u8b93\u9867\u5ba2\u6709\u6a5f\u6703\u518d\u57f7\u884c\u4e00\u6b21\u5237\u5361\u3002"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u5c31\u662f\u57f7\u884c\u7684UI\u756b\u9762\uff0c\u6211\u5011\u5148\u523b\u610f\u5237\u4e00\u6b21\u932f\u8aa4\u7684\u5361\u7247\uff1a\n",(0,r.kt)("img",{parentName:"p",src:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354MSoC0oll9t.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354MSoC0oll9t.png"})),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354i9eWyjVYdN.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354i9eWyjVYdN.png"})),(0,r.kt)("p",null,"\u6240\u4ee5\u7acb\u523b\u53ef\u4ee5\u9a57\u8b49\u90a3\u500b\u91cd\u5237\u5361\u7684\u6309\u9215\uff0c\u5f88\u597d\uff0c\u53c8\u518d\u6b21\u5c0e\u5165\u5237\u5361\u9801\u9762\uff0c\u9019\u6b21\u5c0f\u5fc3\u7ffc\u7ffc\u7684\u8f38\u5165\u6c38\u8c50\u63d0\u4f9b\u7d66\u6211\u5011\u7684\u6e2c\u8a66\u4fe1\u7528\u5361\u5361\u865f\u3002\u5982\u5148\u524d\u8aaa\u660e\uff0c\u56e0\u70ba\u975e\u5b8c\u5168\u516c\u958b\u8cc7\u6599\uff0c\u70ba\u4e86\u6015\u6709\u5fc3\u4eba\u4e8b\u62ff\u53bb\u4e82\u5237\uff0c\u6211\u5011\u5c31\u4e0d\u5728\u6b64\u516c\u958b\u9019\u500b\u6e2c\u8a66\u9801\u9762\u7684\u5167\u5bb9\u548c\u5361\u865f\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354N5EtYIUk6Q.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354N5EtYIUk6Q.png"})),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354ljybM9gioZ.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354ljybM9gioZ.png"})),(0,r.kt)("p",null,"\u5237\u5361\u6210\u529f\u4e86\uff01\u770b\u5230\u7da0\u7da0\u984f\u8272\u7684\u5c31\u89ba\u5f97\u5f88\u5b89\u5168\u5440 (\u54a6\uff0c\u80a1\u5e02\u7684\u8a71\u597d\u50cf\u5c31\u4e0d\u662f\u9019\u7a2e\u611f\u89ba...)"),(0,r.kt)("p",null,"\u4eca\u5929\u982d\u975e\u5e38\u75db\u5440\uff0c\u539f\u672c\u60f3\u7e7c\u7e8c\u5beb\u8a02\u55ae\u67e5\u8a62\u72c0\u614b\u7b49\u7684\u90e8\u4efd\uff0c\u4f46\u72c0\u614b\u4e0d\u597d\u53ea\u80fd\u5beb\u5230\u9019\u88e1\u4e86\uff0c\u660e\u5929\u518d\u7e7c\u7e8c\u5427\u3002\u5929\u5beb\u5b8c\u5169\u7a2e\u4ed8\u6b3e\u65b9\u5f0f\uff0c\u6709\u63d0\u5230\u539f\u5148\u4fe1\u7528\u5361\u5237\u5361\u5f8c\u7684\u7d50\u679c\u5c0e\u56de\u9801",(0,r.kt)("inlineCode",{parentName:"p"},"ReturnURL"),"\u6211\u5011\u9084\u6c92\u5be6\u4f5c\uff0c\u4eca\u5929\u5c31\u628a\u9019\u4e00\u9801\u5b8c\u6210\u3002"),(0,r.kt)("p",null,"\u5148\u8aaa\u660e\u4e00\u4e0b\uff0c\u4fe1\u7528\u5361\u5237\u5361\u6642\uff0c\u4e0d\u6703\u7acb\u5373\u5f97\u5230\u7d50\u679c\uff0c\u6703\u900f\u904e\u6211\u5011\u5728\u5efa\u7acb\u8a02\u55ae\u6642\u50b3\u5165\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"ReturnURL"),"\u53c3\u6578\uff0c\u5f85\u8f49\u5165\u6c38\u8c50\u7dda\u4e0a\u5237\u5361\u9801\u9762\u5f8c\uff0c\u6703\u518d\u900f\u904e\u9019\u500b\u7db2\u5740\u5c0e\u56de\u6211\u5011\u7684\u96fb\u5546\u7d50\u679c\u9801\u3002\u7d30\u90e8\u6d41\u7a0b\u5982\u4e0b"),(0,r.kt)("h3",{id:"\u6d41\u7a0b\u8aaa\u660e-1"},"\u6d41\u7a0b\u8aaa\u660e"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"[\u96fb\u5546]"," \u547c\u53eb\u6c38\u8c50API\uff0c\u5efa\u7acb\u4fe1\u7528\u5361\u4ed8\u6b3e\u65b9\u5f0f\u7684\u8a02\u55ae\uff0c\u5f9eresponse\u53d6\u56de",(0,r.kt)("inlineCode",{parentName:"li"},"card_pay_url"),"\u7d50\u679c\uff0c\u6211\u5011\u5c07\u9867\u5ba2\u5c0e\u5230\u9019\u500b\u7db2\u5740\u53bb\u5237\u5361"),(0,r.kt)("li",{parentName:"ol"},"[\u6c38\u8c50]"," \u5728\u6c38\u8c50\u7684\u7db2\u9801\u9032\u884c\u5237\u5361\uff0c\u56e0\u6b64\u4f7f\u7528\u8005\u7684\u4fe1\u7528\u5361\u6a5f\u654f\u8cc7\u8a0a\u4e0d\u6703\u7559\u5728\u96fb\u5546\u5e73\u53f0\u4e0a"),(0,r.kt)("li",{parentName:"ol"},"[\u6c38\u8c50]"," \u9032\u884c\u4fe1\u7528\u5361\u5237\u5361\u8655\u7406\uff0c\u5148\u7121\u8ad6\u7d50\u679c\uff0c\u5b8c\u6210\u5f8c\u6703\u5c07PayToken\u503c\u50b3\u5165",(0,r.kt)("inlineCode",{parentName:"li"},"ReturnURL"),"\u4e2d"),(0,r.kt)("li",{parentName:"ol"},"[\u96fb\u5546]"," \u9019\u6642\u5019\u6703\u900f\u904eReturnURL\u5c07",(0,r.kt)("inlineCode",{parentName:"li"},"PayToken"),"\u503c\u5e36\u56de\uff0c\u6211\u5011\u5c07\u6b64\u503c\u53d6\u51fa"),(0,r.kt)("li",{parentName:"ol"},"[\u96fb\u5546]"," \u4ee5",(0,r.kt)("inlineCode",{parentName:"li"},"PayToken"),"\u547c\u53eb\u6c38\u8c50API",(0,r.kt)("inlineCode",{parentName:"li"},"\u8a0a\u606f\u67e5\u8a62\u670d\u52d9(OrderPayQuery)")),(0,r.kt)("li",{parentName:"ol"},"[\u6c38\u8c50]"," \u56de\u50b3\u4ed8\u6b3e\u72c0\u614b\u76f8\u95dc\u8cc7\u8a0a"),(0,r.kt)("li",{parentName:"ol"},"[\u96fb\u5546]"," \u5c07\u4ed8\u6b3e\u72c0\u614b\u7d50\u679c\u986f\u793a\u65bc\u9801\u9762\u4e0a\uff0c\u6703\u5206\u5225\u986f\u793a\u5237\u5361\u6210\u529f\u4ee5\u53ca\u5237\u5361\u5931\u6557\u4e0d\u540c\u72c0\u614b\u7684\u8cc7\u8a0a\uff0c\u82e5\u5237\u5361\u5931\u6557\u6211\u5011\u53ef\u518d\u63d0\u4f9b\u4e00\u6b21\u5237\u5361\u9023\u7d50\u679c\u9867\u5ba2")),(0,r.kt)("h3",{id:"view\u7684card_return\u4fee\u6539-1"},"View\u7684card_return\u4fee\u6539"),(0,r.kt)("p",null,"\u5148\u524d\u6211\u5011\u6709\u5beb\u904eView\u4e2d\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"card_return()"),"\uff0c\u7576\u6642\u53ea\u9a57\u8b49\u4e00\u4e9b\u8cc7\u8a0a\u5f80\u4f86\u6b63\u4e0d\u6b63\u78ba\uff0c\u73fe\u5728\u8981\u4f5c\u4e00\u4e9b\u5c0f\u8abf\u6574\uff0c\u4f46\u5e45\u5ea6\u4e0d\u5927\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'def card_return(request):\n    pay_token_dic = {"PayToken": request.POST.get("PayToken"), "ShopNo": request.POST.get("ShopNo")}\n    create_new_paytoken(pay_token_dic["PayToken"])\n    result = update_order_by_paytoken(pay_token_dic)\n    return render(request, \'order/card_return.html\', result)\n')),(0,r.kt)("h5",{id:"\u7a0b\u5f0f\u8aaa\u660e-3"},"\u7a0b\u5f0f\u8aaa\u660e"),(0,r.kt)("p",null,"\u4e3b\u8981\u662f\u7576\u521d\u6211\u5011\u547c\u53eb",(0,r.kt)("inlineCode",{parentName:"p"},"update_order_by_paytoken()"),"\u6642\uff0c\u6c92\u6709\u56de\u50b3\u503c\uff0c\u6211\u5011\u5e0c\u671b\u628a\u6574\u7406\u904e\u5fc5\u8981\u7684\u8cc7\u8a0a\u56de\u50b3\u503c\u62ff\u56de\u4f86\uff0c\u5728\u7b49\u4e00\u4e0b\u7684Template\u4e2d\u4f5c\u70ba\u5224\u65b7\u4ee5\u53ca\u986f\u793a\u76f8\u95dc\u7d50\u679c\u7684\u8a0a\u606f"),(0,r.kt)("p",null,"\u800c\u53e6\u5916\u6211\u5011\u628a\u7576\u521d\u7684HttpResponse\u6539\u6210\u4e86render\u65b9\u5f0f\u5c0e\u5f15\u5230\u65b0\u6e96\u5099\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"order/card_return.html"),"\u4e2d\u3002"),(0,r.kt)("h3",{id:"model\u4e2d\u7684update_order_by_paytoken\u4fee\u6539-1"},"Model\u4e2d\u7684",(0,r.kt)("inlineCode",{parentName:"h3"},"update_order_by_paytoken()"),"\u4fee\u6539"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'def update_order_by_paytoken(paytoken_json):\n    result = {}\n    if paytoken_json:\n        pay_token = paytoken_json["PayToken"]\n        create_new_paytoken(pay_token)\n\n        paytoken_api = QueryByPaytokenMessage()\n        paytoken_api.set_paytoken_json(paytoken_json)\n        resp = ResponsePayToken(paytoken_api.send_query(), paytoken_api.hash_id)\n        print("-- Response: " + str(resp.dec_resp_json))\n\n        order = Payment.objects.get(order_no=resp.orderno)\n        order.pay_status = resp.status\n        order.pay_token = pay_token\n        order.lm_time = datetime.now()\n        order.save()\n\n        result["order_no"] = order.order_no\n        result["status_code"] = order.pay_status\n        if order.pay_status == "S":\n            result["pay_status"] = "\u5237\u5361\u6210\u529f"\n        else:\n            result["pay_status"] = "\u5237\u5361\u5931\u6557"\n        result["card_pay_url"] = order.card_pay_url\n\n        print(" Update Order Successfully.")\n    else:\n        print(" Update Order Fail.")\n    return result\n')),(0,r.kt)("h5",{id:"\u7a0b\u5f0f\u8aaa\u660e-4"},"\u7a0b\u5f0f\u8aaa\u660e"),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"update_order_by_paytoken()"),"\u4e2d\uff0c\u6211\u5011\u4e3b\u8981\u6e96\u5099\u4e86\u4e00\u500b",(0,r.kt)("inlineCode",{parentName:"p"},"result"),"\u4f5c\u70ba\u56de\u50b3\uff0c\u628a\u6240\u9700\u8981\u7684\u5fc5\u8981\u8cc7\u8a0a\u6574\u7406\u6210dictionary\u56de\u50b3\u56de\u53bb\uff0c\u5728\u9019\u88e1\u9806\u4fbf\u628a",(0,r.kt)("inlineCode",{parentName:"p"},"pay_status"),"\u4e2d\u7684\u4ee3\u78bc\u63db\u6210\u4e86\u53ef\u95b1\u8b80\u7684\u986f\u793a\u6587\u5b57\u3002"),(0,r.kt)("p",null,"\u4e0d\u904e\u6211\u5fc5\u9808\u518d\u4e09\u5f37\u8abf\uff0c\u9019\u6a23\u7684\u5beb\u6cd5\u4e26\u975e\u7522\u54c1\u7b49\u7d1a\u7684\u64b0\u5beb\u65b9\u6cd5\uff0c\u9019\u4e5f\u4e0d\u662f\u5728\u9019\u7cfb\u5217\u6587\u7ae0\u4e2d\u6211\u6253\u7b97\u5be6\u4f5c\u7684\uff0c\u90a3\u6a23\u53ea\u6703\u5c0d\u4e3b\u8981\u8981\u4ecb\u7d39\u6c38\u8c50API\u7684\u4e32\u63a5\u5931\u7126\u4e86\u3002\u4f46\u6211\u5011\u53ef\u4ee5\u8ac7\u4e00\u8ac7\u53ef\u4ee5\u600e\u9ebc\u505a\u6703\u6bd4\u8f03\u597d\u3002"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5728Model\u88e1\u9762\u5373\u4f7f\u4f7f\u7528\u4e86\u539f\u672c\u4ee3\u78bc\u8981\u8f49\u6210\u53ef\u95b1\u8b80\u6587\u5b57\uff0c\u4e26\u4e0d\u6703\u76f4\u63a5\u9019\u6a23\u8655\u7406\uff0c\u7121\u8ad6\u4f60\u7684\u7db2\u7ad9\u4e00\u958b\u59cb\u662f\u4e0d\u662f\u55ae\u4e00\u8a9e\u8a00\uff0c\u9019\u7a2e\u6700\u7d42\u8981\u986f\u793a\u5728UI\u4e0a\u7684\u6587\u5b57\uff0c\u4e0d\u6703\u5728Model\u88e1\u76f4\u63a5\u66ff\u63db\uff0c\u81f3\u5c11\u9700\u8003\u91cf\u5230i18n\u591a\u570b\u8a9e\u7cfb\u3002"),(0,r.kt)("li",{parentName:"ol"},"\u5373\u4f7f\u6c92\u6709\u8981\u505a\u591a\u570b\u8a9e\u7cfb\uff0c\u9019\u6a23\u7684UI\u6587\u5b57\u66ff\u63db\uff0c\u4e5f\u4e0d\u6703\u5728\u8655\u7406\u5c08\u8077\u529f\u80fd\u7684\u5546\u696d\u908f\u8f2f\u4e2d\u5be6\u4f5c\uff0c\u597d\u4e00\u9ede\u7684\u65b9\u5f0f\u6703\u5beb\u5728\u56de\u50b3\u4e4b\u5f8c\uff0c\u518d\u547c\u53eb\u53e6\u4e00\u500b\u5c08\u9580\u8655\u7406\u4ee3\u78bc\u8f49\u6587\u5b57\u7684Converter\u908f\u8f2f\u3002"),(0,r.kt)("li",{parentName:"ol"},'\u4e0a\u9762\u9019\u500bConverter\uff0c\u53e6\u4e00\u500b\u547c\u53eb\u968e\u6bb5\u53ef\u64fa\u5728View\u7684\u90a3\u5c64\u4f86\u8655\u7406(\u6211\u8aaa\u7684\u662fView\uff0c\u4e0d\u662fTemplate)\uff0c\u4f46\u4e0d\u662f\u5728View\u5c64\u76f4\u63a5\u4f5c\u4ee3\u78bc\u8f49\u6587\u5b57\uff0c\u800c\u662f\u5728View\u90a3\u5c64"\u518d\u547c\u53eb\u8655\u7406\u8f49\u63db\u7684\u908f\u8f2f"\uff0c\u7562\u7adf\u9019\u500b\u6700\u7d42\u7684\u5167\u5bb9\u662f\u5c6c\u65bc\u504fUI\u7684\u5167\u5bb9\u3002')),(0,r.kt)("p",null,"\u4f46\u70ba\u4e86\u7bc4\u4f8b\u65b9\u4fbf\uff0c\u6211\u5011\u5c31\u76f4\u63a5\u5728Model\u88e1\u8655\u7406\u6389\u4e86\uff0c\u4f46\u9019\u7d55\u5c0d\u4e0d\u662f\u6700\u597d\u7684\u4f5c\u6cd5\u3002"),(0,r.kt)("h3",{id:"\u53ef\u4ee5\u4f86\u770btemplate\u4e86-1"},"\u53ef\u4ee5\u4f86\u770bTemplate\u4e86"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'{% extends "base.html" %}\n\n{% block title %}{{ title }}{% endblock %}\n\n{% block body %}\n<div id="app" class="row g-3 align-self-center">\n<h1 class="display-4 text-center  mb-3 mt-5">\u4fe1\u7528\u5361\u5237\u5361\u7d50\u679c</h1>\n<p class="lead  text-center">\u611f\u8b1d\u60a8\u4f7f\u7528\u6c38\u8c50\u7dda\u4e0a\u4fe1\u7528\u5361\u5237\u5361\u670d\u52d9\uff0c\u4ee5\u4e0b\u662f\u60a8\u7684\u5237\u5361\u7d50\u679c\u5594\uff01</p>\n<hr/>\n<div class="container-fluid">\n    <h3 class="mb-5">\n      \u8a02\u55ae\u865f\u78bc <small class="text-muted">{{ order_no }}</small>\n    </h3>\n    <div class="border border-secondary rounded m-2 {% if status_code == \'S\' %}bg-success{% else %}bg-danger{% endif %}\n    text-white p-3">\n        <h6>\u60a8\u7684\u5237\u5361\u7d50\u679c</h6>\n        <p>\n            <span class="primary fs-4">{{ pay_status }}</span>\n        </p>\n        {% if status_code != \'S\' %}\n            <a href="{{ card_pay_url }}" class="btn btn-light btn-lg" tabindex="-1" role="button" aria-disabled="true">\u518d\u6b21\u4f7f\u7528\u6c38\u8c50\u4fe1\u7528\u5361\u5237\u5361</a>\n        {% endif %}\n\n    </div>\n    <br/><br/><br/><br/>\n    <hr/>\n    <div class="row mt-3">\n        <div class="col text-center">\n            <a href="{% url \'order_create_entrance\' %}" class="btn btn-primary btn-lg" tabindex="-1" role="button" aria-disabled="true">\u7e7c\u7e8c\u8cfc\u8cb7</a>\n            &nbsp\n            <a href="{% url \'my_orders\' %}" class="btn btn-secondary btn-lg" tabindex="-1" role="button" aria-disabled="true">\u56de\u5230\u8a02\u55ae</a>\n        </div>\n    </div>\n</div>\n</div>\n{% endblock %}\n\n{% block script %}\n{% endblock %}\n')),(0,r.kt)("h5",{id:"\u7a0b\u5f0f\u8aaa\u660e-5"},"\u7a0b\u5f0f\u8aaa\u660e"),(0,r.kt)("p",null,"\u5237\u5361\u7d50\u679c\u7576\u7136\u5c31\u76f4\u63a5\u628a\u525b\u525b\u4e0a\u9762\u8ac7\u534a\u5929\u7684",(0,r.kt)("strong",{parentName:"p"},"\u5237\u5361\u7d50\u679c\u7684UI\u6587\u5b57"),"\u76f4\u63a5\u4ee5",(0,r.kt)("inlineCode",{parentName:"p"},"{{ pay_status }}"),"\u986f\u793a\u51fa\u4f86\u3002\u4f46\u6211\u5011\u5e0c\u671b\u5728\u7d50\u679c\u7684\u4e8c\u5206\u4e16\u754c\u4e2d\uff0c\u4ee5\u984f\u8272\u4f86\u4f5c\u660e\u986f\u7684\u5340\u9694\uff0c\u56e0\u6b64\u5c31\u53ef\u4ee5\u62ff",(0,r.kt)("inlineCode",{parentName:"p"},"status_code"),"\u7d50\u679c\u4ee3\u78bc\u5c0d\u5237\u5361\u6210\u529f\u6216\u5931\u6557\u6539\u8b8a\u984f\u8272\uff0c\u9019\u88e1\u900f\u904eBootstrap\u7684\u57fa\u672c\u5e7e\u500b\u8272\u8abf\u4f86\u8abf\u6574div\u7684\u80cc\u666f\u984f\u8272\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u6210\u529f\uff1abg-success"),(0,r.kt)("li",{parentName:"ul"},"\u5931\u6557\uff1abg-danger")),(0,r.kt)("p",null,"\u7136\u5f8c\u5728\u5931\u6557\u7684\u6642\u5019\uff0c\u518d\u6b21\u5c07\u5237\u5361\u7db2\u5740\u6309\u9215\u9644\u4e0a\uff0c\u8b93\u9867\u5ba2\u6709\u6a5f\u6703\u518d\u57f7\u884c\u4e00\u6b21\u5237\u5361\u3002"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u5c31\u662f\u57f7\u884c\u7684UI\u756b\u9762\uff0c\u6211\u5011\u5148\u523b\u610f\u5237\u4e00\u6b21\u932f\u8aa4\u7684\u5361\u7247\uff1a\n",(0,r.kt)("img",{parentName:"p",src:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354MSoC0oll9t.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354MSoC0oll9t.png"})),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354i9eWyjVYdN.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354i9eWyjVYdN.png"})),(0,r.kt)("p",null,"\u6240\u4ee5\u7acb\u523b\u53ef\u4ee5\u9a57\u8b49\u90a3\u500b\u91cd\u5237\u5361\u7684\u6309\u9215\uff0c\u5f88\u597d\uff0c\u53c8\u518d\u6b21\u5c0e\u5165\u5237\u5361\u9801\u9762\uff0c\u9019\u6b21\u5c0f\u5fc3\u7ffc\u7ffc\u7684\u8f38\u5165\u6c38\u8c50\u63d0\u4f9b\u7d66\u6211\u5011\u7684\u6e2c\u8a66\u4fe1\u7528\u5361\u5361\u865f\u3002\u5982\u5148\u524d\u8aaa\u660e\uff0c\u56e0\u70ba\u975e\u5b8c\u5168\u516c\u958b\u8cc7\u6599\uff0c\u70ba\u4e86\u6015\u6709\u5fc3\u4eba\u4e8b\u62ff\u53bb\u4e82\u5237\uff0c\u6211\u5011\u5c31\u4e0d\u5728\u6b64\u516c\u958b\u9019\u500b\u6e2c\u8a66\u9801\u9762\u7684\u5167\u5bb9\u548c\u5361\u865f\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354N5EtYIUk6Q.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354N5EtYIUk6Q.png"})),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354ljybM9gioZ.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211008/20130354ljybM9gioZ.png"})),(0,r.kt)("p",null,"\u5237\u5361\u6210\u529f\u4e86\uff01\u770b\u5230\u7da0\u7da0\u984f\u8272\u7684\u5c31\u89ba\u5f97\u5f88\u5b89\u5168\u5440 (\u54a6\uff0c\u80a1\u5e02\u7684\u8a71\u597d\u50cf\u5c31\u4e0d\u662f\u9019\u7a2e\u611f\u89ba...)"),(0,r.kt)("p",null,"\u4eca\u5929\u982d\u975e\u5e38\u75db\u5440\uff0c\u539f\u672c\u60f3\u7e7c\u7e8c\u5beb\u8a02\u55ae\u67e5\u8a62\u72c0\u614b\u7b49\u7684\u90e8\u4efd\uff0c\u4f46\u72c0\u614b\u4e0d\u597d\u53ea\u80fd\u5beb\u5230\u9019\u88e1\u4e86\uff0c\u660e\u5929\u518d\u7e7c\u7e8c\u5427\u3002\u6628\u5929\u62b1\u75c5\u64b0\u6587\uff0c\u7d42\u65bc\u5728\u672c\u6a5f\u7aef\u5c07\u55ae\u7b46\u8cc7\u6599\u900f\u904eORM\u7684\u65b9\u6cd5\uff0c\u6210\u529f\u5c07\u65b0\u589e\u7684\u8a02\u55ae\u8cc7\u6599\u66f4\u65b0\u5230Heroku Postgres\u8cc7\u6599\u5eab\u4e2d(\u975e\u5e38\u611f\u52d5)\uff0c\u4eca\u5929\u6211\u5011\u8981\u4f86\u5b8c\u6210\u5269\u4e0b\u53d6\u5f97PayToken\u7684\u6700\u5f8c\u4e00\u54e9\u8def\u3002"),(0,r.kt)("h3",{id:"\u53ea\u6709\u62ff\u5230paytoken\u9019\u9ebc\u7c21\u55ae\u55ce"},"\u53ea\u6709\u62ff\u5230PayToken\u9019\u9ebc\u7c21\u55ae\u55ce"),(0,r.kt)("p",null,"\u5148\u524d\u5df2\u7d93\u505a\u597dcreate order\u7684View\uff0c\u53ef\u4ee5\u65b0\u589e\u8cc7\u6599\uff0c\u9084\u8a18\u5f97\u6709\u4e00\u500b\u95dc\u9375\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"BackendURL"),"\u7684\u53c3\u6578\u662f\u5728\u6211\u5011\u547c\u53ebAPI\u6642\u6703\u50b3\u5165\u7684\u53c3\u6578\u55ce\uff1f\u9019\u500b\u5c31\u662f\u70ba\u4e86\u8b93\u6c38\u8c50API\u77e5\u9053\u5230\u6642\u5019\u8981\u5c07PayToken\u50b3\u56de\u5230\u54ea\u88e1\u8b93\u6211\u5011\u63a5\u624b\u9032\u884c\u8655\u7406\u3002"),(0,r.kt)("p",null,"\u9019\u9805\u529f\u80fd\u5176\u5be6\u5728\u958b\u767c\u898f\u683c\u66f8\u4e2d\uff0c\u662f\u5b9a\u7fa9\u70ba\u300c\u5373\u6642\u8a0a\u606f\u901a\u77e5\u300d\uff0c\u8001\u5be6\u8aaa\u5982\u679c\u76f4\u63a5\u770b\u540d\u7a31\uff0c\u4e0d\u662f\u5f88\u5bb9\u6613\u7406\u89e3\u5176\u529f\u7528\uff0c\u4ee5\u70ba\u662f\u985e\u4f3cPush Notifcation\uff0c\u4f46\u5b8c\u5168\u4e0d\u662f\u3002\u9019\u500b\u529f\u80fd\u7d14\u7cb9\u662f\u6c38\u8c50API\u6703\u767c\u9001\u7d66\u5c1a\u672a\u56de\u5831\u7d50\u6848\u7684TSNo\uff0c\u8981\u50b3\u7d66\u4ed6\u5011PayToken\u3002"),(0,r.kt)("p",null,"\u6587\u4ef6\u8aaa\u660e\u5982\u4e0b\uff1a"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"STEP1\uff1a\u5728\u300c7.1 \u5efa\u7acb\u8a02\u55ae\u4ea4\u6613\u300d\u6709\u50b3\u9001BackendURL\u4e14\u8a72\u8a02\u55ae\u300c\u4ed8\u6b3e\u5b8c\u6210\u300d\u6216\u300c\u6307\u5b9a\u9810\u8a08\u81ea\u52d5\u8acb\u6b3e\u300d\u5b8c\u6210\u8acb\u6b3e\u6642\u5247\u6703 \u900f\u904e\u6b64\u901a\u77e5\u50b3\u9001\u8a0a\u606fToken\u503c\u7d66\u60a8\uff0c\u60a8\u6536\u5230\u5f8c\u9700\u56de\u8986\u63a5\u6536\u6210\u529f\uff0c\u5982\u672a\u56de\u8986\u7cfb\u7d71\u6703\u6bcf\u969410\u5206\u9418\u91cd\u65b0\u767c\u9001\u4e00\u6b21\uff0c\u76f4\u5230\u5931\u65575\u6b21\u5f8c\u624d\u6703\u505c\u6b62\u767c\u9001\u3002\nSTEP2\uff1a\u63a5\u6536\u5230Token\u503c\u5f8c\uff0c\u8acb\u900f\u904e\u7528\u300c7.3 \u8a0a\u606f\u67e5\u8a62\u670d\u52d9\u300d\u4f86\u78ba\u8a8d\u8a02\u55ae\u4ed8\u6b3e\u662f\u5426\u6210\u529f\u6216\u662f\u5931\u6557\u3002")),(0,r.kt)("p",null,"\u56e0\u6b64\u6211\u5011\u8981\u5728\u9019\u500b\u8b93API\u56de\u547c\u7684URL\u4e2d\uff0c\u9664\u4e86\u5be6\u4f5c\u63a5\u6536\u9019\u500bPayToken\u7684\u300c\u5373\u6642\u8a0a\u606f\u901a\u77e5\u300d\u5916\uff0c\u9084\u9023\u5e36\u7684\u8981\u547c\u53eb\u300c\u8a0a\u606f\u67e5\u8a62\u670d\u52d9\u300d\u624d\u80fd\u5f97\u5230\u4ed8\u6b3e\u7684\u7d50\u679c\u3002"),(0,r.kt)("h4",{id:"step1-\u958b\u500b\u7db2\u5740\u63a5\u53e3\u4f86\u8655\u7406paytoken"},"STEP1\uff1a \u958b\u500b\u7db2\u5740\u63a5\u53e3\u4f86\u8655\u7406PayToken"),(0,r.kt)("p",null,"\u9019\u500b\u300c\u5373\u6642\u8a0a\u606f\u901a\u77e5\u300d\u662f\u4e00\u500b\u88ab\u52d5\u88ab\u53eb\u7528\u7684\u7db2\u9801\uff0c\u7c21\u55ae\u8aaa\uff0c\u9019\u662f\u6211\u65b9\u96fb\u5546\u63d0\u4f9b\u7684API (\u53ea\u662f\u9019\u500bAPI\u662f\u5225\u4eba\u8a02\u7684\u898f\u5247)\uff0c\u53e6\u4e00\u7a2e\u8aaa\u6cd5\u662f\u6211\u5011\u63d0\u4f9b\u4e86\u4e00\u500bWebhook\u7d66\u4e00\u958b\u59cb\u7684API\uff0c\u5728\u5b8c\u6210\u67d0\u4e9b\u4e8b\u5f8c\u53ef\u4ee5\u56de\u547c\u53eb\u7528\u901a\u77e5\u6211\u5011\u3002"),(0,r.kt)("p",null,"\u9019\u500bWebhook\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u7a31\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"BackendURL"),"\uff0c\u88e1\u9762\u6703\u50b3\u5165\u7684\u6771\u897f\u5c31\u53ea\u6709\u5169\u500b\u5c6c\u6027\u7684JSON\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n"ShopNo":"NA0249_001",\n"PayToken":"da1547c3d0d1649af5049125b0880c0e227f31e107cbf4f0995bed28d0f066c1"\n}\n')),(0,r.kt)("p",null,"\u6240\u4ee5\u6211\u5011\u5728Django\u7684View\u4e2d\uff0c\u53d6\u5f97request\u53c3\u6578\u6642\uff0c\u96d6\u7136\u662f\u4e00\u500bPOST\u7684Method\uff0c\u4f46\u6211\u5011\u53d6\u7528\u9019\u500b\u8cc7\u6599\u9700\u8981\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"request.body"),"\u4f86\u62ff\u5230\u5b8c\u6574\u7684JSON\u503c\u3002"),(0,r.kt)("p",null,"\u5148\u4e0d\u8ad6\u5f8c\u9762\u6211\u5011\u9084\u9700\u8981\u505aPayToken\u7684\u67e5\u8a62\uff0c\u4f46\u6211\u5011\u8981\u56de\u8986\u6c38\u8c50API\u4e00\u500b\u56fa\u5b9a\u7684\u7d50\u6848\u72c0\u614b\u78bc\uff0c\u56fa\u5b9a\u5c31\u662f\u7528JSON\u5305\u88dd\u4e00\u500b",(0,r.kt)("inlineCode",{parentName:"p"},"Status"),"\u5c6c\u6027\uff0c\u4e26\u56de\u50b3",(0,r.kt)("inlineCode",{parentName:"p"},"S"),"\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{"Status": "S"}\n')),(0,r.kt)("p",null,"\u7c21\u55ae\u5728View\u4e2d\u6e96\u5099\u4e00\u500b",(0,r.kt)("inlineCode",{parentName:"p"},"get_paytoken"),"\uff0c\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'def get_paytoken(request):\n    if request.method == \'POST\':\n        result_str = request.body\n        result_json = json.loads(result_str)\n        print(" --- PayToken Callback: {}".format(result_json))\n        update_order_by_paytoken(result_json)\n\n        resp_json = {"Status": "S"}\n    return HttpResponse(json.dumps(resp_json))\n')),(0,r.kt)("h4",{id:"step2-\u67e5\u8a62\u9867\u5ba2\u4ed8\u6b3e\u72c0\u614b"},"STEP2\uff1a \u67e5\u8a62\u9867\u5ba2\u4ed8\u6b3e\u72c0\u614b"),(0,r.kt)("p",null,"\u53d6\u5f97\u91cd\u8981\u7684PayToken\u5f8c\uff0c\u63a5\u8457\u5c31\u53ef\u4ee5\u9032\u884c\u300c\u8a0a\u606f\u67e5\u8a62\u670d\u52d9\u300d\u4e86\u3002\u9019\u500b\u9700\u547c\u53eb\u7684API Function\u70ba",(0,r.kt)("inlineCode",{parentName:"p"},"OrderPayQuery"),"\uff0c\u4ed6\u7684\u8f38\u5165\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"Message"),"\u503c\u5176\u5be6\u5c31\u662f\u628a\u525b\u525bBackendURL\u53d6\u56de\u7684JSON\u539f\u5c01\u4e0d\u52d5\u4e1f\u9032\u53bb\u5c31\u884c\u4e86\u3002"),(0,r.kt)("p",null,"\u4f46\u8981\u547c\u53eb\u7684\u4f5c\u6cd5\uff0c\u9700\u8981\u548c\u7576\u521d\u505a",(0,r.kt)("inlineCode",{parentName:"p"},"OrderCreate"),"\u4e00\u6a21\u4e00\u6a23\uff0c\u8a72\u4e1f\u7684API\u57fa\u790e\u53c3\u6578\u4ee5\u53ca\u52a0\u89e3\u5bc6\u6d41\u7a0b\u5168\u90fd\u9700\u8981\u91cd\u4f5c\u4e00\u904d\uff0c\u4eca\u5929\u5148\u628a\u6d41\u7a0b\u8b1b\u5b8c\uff0c\u9019\u90e8\u4efd\u9700\u8981\u628a\u53ef\u91cd\u8986\u4f7f\u7528\u7684code\u6574\u7406\u904e\u5f8c\uff0c\u518d\u4f86\u5be6\u4f5c\u3002"),(0,r.kt)("p",null,"\u5176\u4e2d\u62ff\u56de\u7684\u7d50\u679c\u6709\u5f88\u591a\u5c6c\u6027\uff0c\u8f03\u70ba\u91cd\u8981\u7684\u6709\uff1a\n| \u5c6c\u6027    | \u8aaa\u660e                                                         |\n| ------- | ------------------------------------------------------------ |\n| APType  | \u8a0a\u606f\u985e\u578b",(0,r.kt)("br",null),"\u5728\u9019\u88e1\u61c9\u70baPayOut\uff0c\u8868\u793a\u300c\u4ed8\u6b3e\u7d50\u679c\u300d\u7684\u901a\u77e5       |\n| TSNo    | \u8c50\u6536\u6b3e\u7684\u4ea4\u6613\u865f\u78bc\uff0c\u53ef\u4ee5\u7528\u6b64\u8207\u8cc7\u6599\u5eab\u4f5c\u95dc\u806f\uff0c\u4e5f\u53ef\u4ee5\u7528\u6211\u5011\u81ea\u5df1\u7684\u8a02\u55ae\u7de8\u865f\u3002 |\n| Status  | \u8655\u7406\u72c0\u614b",(0,r.kt)("br",null),"S\uff1a\u8655\u7406\u6210\u529f \u6b63\u5e38",(0,r.kt)("br",null),"F\uff1a\u8655\u7406\u5931\u6557 \u932f\u8aa4          |\n| PayDate | \u4ed8\u6b3e\u6642\u9593/\u8acb\u6b3e\u6642\u9593\uff0c \u4f8b\u5982\uff1a2021/9/30 22:32 \u683c\u5f0f 202109302232 \u3002 |"),(0,r.kt)("p",null,"\u6211\u5011\u53ef\u4ee5\u5beb\u4e00\u500bModel\u7684\u65b9\u6cd5\u4f86\u8655\u7406\uff0c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'def update_order_by_paytoken(paytoken_json):\n    if paytoken_json:\n        pay_token = paytoken_json["PayToken"]\n        resp_json = SinopacAPI.query_by_paytoken(paytoken_json)\n        tsno = resp_json["TSNo"]\n        order_no = resp_json["OrderNo"]\n        status = resp_json["Status"]\n\n        order = Payment.objects.filter(order_no=order_no)\n        order.status = status\n        order.pay_token = pay_token\n        order.lm_time = datetime.now()\n        order.save()\n        print(" Update Order Successfully.")\n    else:\n        print(" Update Order Fail.")\n')),(0,r.kt)("h4",{id:"\u7d00\u9304\u88abapi\u56de\u547c\u7d00\u9304"},"\u7d00\u9304\u88abAPI\u56de\u547c\u7d00\u9304"),(0,r.kt)("p",null,"\u82e5\u662f\u6211\u5011\u7684BackendURL\u6709\u88abAPI\u547c\u53eb\u6642\uff0c\u53ef\u5efa\u7acb\u4e00\u500bPayToken\u7684\u7d00\u9304Table\u4ee5\u4f5c\u70baLog\u4f7f\u7528\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'class PayToken(models.Model):\n    pay_token = models.CharField(max_length=100, null=True)\n    create_time = models.DateTimeField()\n\n\ndef create_new_paytoken(pay_token):\n    new_paytoken = PayToken()\n    new_paytoken.pay_token = pay_token\n    new_paytoken.create_time = datetime.now()\n    new_paytoken.save()\n    print("--- Create New PayToken")\n')),(0,r.kt)("p",null,"\u4e26\u884c\u5728\u539f\u672cView\u7684get_paytoken()\u4e2d\uff0c\u52a0\u5165",(0,r.kt)("inlineCode",{parentName:"p"},'create_new_paytoken(result_json["PayToken"])'),"\uff0c\u5247\u53ef\u7d00\u9304PayToken\u88ab\u56de\u547c\u7684\u7d00\u9304\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'def get_paytoken(request):\n    if request.method == \'POST\':\n        result_str = request.body\n        result_json = json.loads(result_str)\n        print(" --- PayToken Callback: {}".format(result_json))\n        create_new_paytoken(result_json["PayToken"])\n        update_order_by_paytoken(result_json)\n\n        resp_json = {"Status": "S"}\n    return HttpResponse(json.dumps(resp_json))\n')),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://ithelp.ithome.com.tw/upload/images/20211001/20130354y1PyEjiFaC.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211001/20130354y1PyEjiFaC.png"})),(0,r.kt)("p",null,"\u4eca\u5929\u5148\u5beb\u5230\u9019\u5152\uff0c\u660e\u5929\u7e7c\u7e8c\u5be6\u4f5cOrderPayCreate\u7684\u52a0\u89e3\u5bc6API\u5168\u6d41\u7a0b\u5be6\u4f5c\u3002"))}u.isMDXComponent=!0}}]);