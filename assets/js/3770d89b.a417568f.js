"use strict";(self.webpackChunkmy_site=self.webpackChunkmy_site||[]).push([[6573],{5853:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>_,frontMatter:()=>r,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"finance-bank-api/Day17 - \u6c38\u8c50API\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u8207PayToken\u67e5\u8a62\u8207\u66f4\u65b0\u72c0\u614b","title":"Day17 - \u6c38\u8c50API\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u8207PayToken\u67e5\u8a62\u8207\u66f4\u65b0\u72c0\u614b","description":"\u5728\u7d93\u904e\u4e86\u591a\u65e5\u6709\u4e00\u5929\u6c92\u4e00\u5929\u7684\u7814\u7a76\u3001\u5bebCode\u8207\u5beb\u4f5c\uff0c\u4eca\u5929\u5047\u65e5\u82b1\u4e86\u4e00\u9ede\u6642\u9593\u5c07\u539f\u672c\u5f9eJupyter Notebook\u96f6\u96f6\u6563\u6563\u7684Code\uff0c\u642c\u5230PyCharm\u5f8c\u4e5f\u662f\u7d30\u7d30\u788e\u788e\u7684\u7a0b\u5f0f\u78bc\u91cd\u65b0\u9032\u884c\u91cd\u69cb\u8207\u7ffb\u4fee\uff0c\u80fd\u5beb\u6210\u7269\u4ef6\u5c0e\u5411\u7684\u65b9\u5f0f\u5c31\u8abf\u6574\uff0c\u7d42\u65bc\u5c07\u5b8c\u6574\u7684ATM\u865b\u64ec\u5e33\u6236\u7684\u5be6\u4f5c\u5b8c\u6210\u4e86\uff0c\u6709\u4e86\u9019\u500b\u57fa\u790e\uff0c\u5269\u4e0b\u7684\u4fe1\u7528\u5361\u4ed8\u6b3e\u5c31\u5f88\u7c21\u55ae\u4e86\u3002","source":"@site/docs/finance-bank-api/Day17 - \u6c38\u8c50API\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u8207PayToken\u67e5\u8a62\u8207\u66f4\u65b0\u72c0\u614b.md","sourceDirName":"finance-bank-api","slug":"/finance-bank-api/Day17 - \u6c38\u8c50API\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u8207PayToken\u67e5\u8a62\u8207\u66f4\u65b0\u72c0\u614b","permalink":"/docs/finance-bank-api/Day17 - \u6c38\u8c50API\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u8207PayToken\u67e5\u8a62\u8207\u66f4\u65b0\u72c0\u614b","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":18,"frontMatter":{"sidebar_position":18},"sidebar":"tutorialSidebar","previous":{"title":"Day16 - \u53d6\u5f97PayToken\u7684\u6700\u5f8c\u4e00\u54e9\u8def\u5f88\u6162\u9577","permalink":"/docs/finance-bank-api/Day16 - \u53d6\u5f97PayToken\u7684\u6700\u5f8c\u4e00\u54e9\u8def\u5f88\u6162\u9577"},"next":{"title":"Day18 - \u63d0\u4f9b\u4fe1\u7528\u5361\u4ed8\u6b3e\u4ee5\u53ca\u53d6\u5f97PayToken\u6d41\u7a0b","permalink":"/docs/finance-bank-api/Day18 - \u63d0\u4f9b\u4fe1\u7528\u5361\u4ed8\u6b3e\u4ee5\u53ca\u53d6\u5f97PayToken\u6d41\u7a0b"}}');var t=s(4848),o=s(8453);const r={sidebar_position:18},i=void 0,l={},d=[{value:"\u6d41\u7a0b\u62c6\u89e3",id:"\u6d41\u7a0b\u62c6\u89e3",level:3},{value:"\u7269\u4ef6\u5c0e\u5411\u985e\u5225\u898f\u5283",id:"\u7269\u4ef6\u5c0e\u5411\u985e\u5225\u898f\u5283",level:3},{value:"\u7a0b\u5f0f\u78bc\u96c6\u5408",id:"\u7a0b\u5f0f\u78bc\u96c6\u5408",level:3},{value:"\u901a\u7528\u5de5\u5177class SinopacUtil",id:"\u901a\u7528\u5de5\u5177class-sinopacutil",level:4},{value:"\u5171\u540c\u7236\u985e\u5225class ApiMessage",id:"\u5171\u540c\u7236\u985e\u5225class-apimessage",level:4},{value:"\u5efa\u7acbATM\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u4e4b\u8a02\u55ae\u985e\u5225AtmAccountMessage",id:"\u5efa\u7acbatm\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u4e4b\u8a02\u55ae\u985e\u5225atmaccountmessage",level:4},{value:"\u4ee5PayToken\u67e5\u8a62\u76f8\u95dc\u4ed8\u6b3e\u8cc7\u8a0a\u985e\u5225QueryByPaytokenMessage",id:"\u4ee5paytoken\u67e5\u8a62\u76f8\u95dc\u4ed8\u6b3e\u8cc7\u8a0a\u985e\u5225querybypaytokenmessage",level:4},{value:"\u5171\u540c\u7236\u985e\u5225class ResponseMessage",id:"\u5171\u540c\u7236\u985e\u5225class-responsemessage",level:4},{value:"ATM\u67e5\u8a62\u7d50\u679c\u985e\u5225ResponseATM",id:"atm\u67e5\u8a62\u7d50\u679c\u985e\u5225responseatm",level:4},{value:"\u4ee5PayToken\u67e5\u8a62\u5b8c\u7684\u4ed8\u6b3e\u8cc7\u8a0a\u7d50\u679c\u985e\u5225ResponsePayToken",id:"\u4ee5paytoken\u67e5\u8a62\u5b8c\u7684\u4ed8\u6b3e\u8cc7\u8a0a\u7d50\u679c\u985e\u5225responsepaytoken",level:4},{value:"\u7d50\u679c\u9a57\u8b49",id:"\u7d50\u679c\u9a57\u8b49",level:3},{value:"STEP1: \u5728View\u4e2d\u57f7\u884c\u5efa\u7acb\u65b0\u55ae",id:"step1-\u5728view\u4e2d\u57f7\u884c\u5efa\u7acb\u65b0\u55ae",level:4},{value:"STEP2: \u67e5\u8a62\u76ee\u524d\u8cc7\u6599\u5eab\u72c0\u614b\uff0c\u65b0\u8a02\u55ae\u8cc7\u6599\u9032\u4f86\u4e86",id:"step2-\u67e5\u8a62\u76ee\u524d\u8cc7\u6599\u5eab\u72c0\u614b\u65b0\u8a02\u55ae\u8cc7\u6599\u9032\u4f86\u4e86",level:4},{value:"STEP3: BackendURL\u88ab\u547c\u53eb\uff0c\u66f4\u65b0\u8cc7\u6599\u5eab\u4ed8\u6b3e\u72c0\u614b",id:"step3-backendurl\u88ab\u547c\u53eb\u66f4\u65b0\u8cc7\u6599\u5eab\u4ed8\u6b3e\u72c0\u614b",level:4}];function p(e){const n={code:"code",h3:"h3",h4:"h4",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"\u5728\u7d93\u904e\u4e86\u591a\u65e5\u6709\u4e00\u5929\u6c92\u4e00\u5929\u7684\u7814\u7a76\u3001\u5bebCode\u8207\u5beb\u4f5c\uff0c\u4eca\u5929\u5047\u65e5\u82b1\u4e86\u4e00\u9ede\u6642\u9593\u5c07\u539f\u672c\u5f9eJupyter Notebook\u96f6\u96f6\u6563\u6563\u7684Code\uff0c\u642c\u5230PyCharm\u5f8c\u4e5f\u662f\u7d30\u7d30\u788e\u788e\u7684\u7a0b\u5f0f\u78bc\u91cd\u65b0\u9032\u884c\u91cd\u69cb\u8207\u7ffb\u4fee\uff0c\u80fd\u5beb\u6210\u7269\u4ef6\u5c0e\u5411\u7684\u65b9\u5f0f\u5c31\u8abf\u6574\uff0c\u7d42\u65bc\u5c07\u5b8c\u6574\u7684ATM\u865b\u64ec\u5e33\u6236\u7684\u5be6\u4f5c\u5b8c\u6210\u4e86\uff0c\u6709\u4e86\u9019\u500b\u57fa\u790e\uff0c\u5269\u4e0b\u7684\u4fe1\u7528\u5361\u4ed8\u6b3e\u5c31\u5f88\u7c21\u55ae\u4e86\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"\u6d41\u7a0b\u62c6\u89e3",children:"\u6d41\u7a0b\u62c6\u89e3"}),"\n",(0,t.jsx)(n.p,{children:"\u5148\u5206\u4eab\u4e00\u4e0b\u6211\u7684\u5be6\u4f5c\u6d41\u7a0b\uff1a"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["[View] \u63d0\u4f9b\u6a21\u64ec\u5efa\u7acb\u65b0ATM\u4ed8\u6b3e\u8a02\u55ae\u7684\u7db2\u9801 (",(0,t.jsx)(n.code,{children:"/order/create_atm_order"}),")","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u4e82\u6578\u7522\u751f\u8a02\u55ae\u7e3d\u91d1\u984d"}),"\n",(0,t.jsxs)(n.li,{children:["\u547c\u53ebModel\u76f8\u5c0d\u7684",(0,t.jsx)(n.code,{children:"create_new_atm_order"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["[Model] \u5efa\u7acb\u65b0ATM\u865b\u64ec\u5e33\u6236\u7684\u8a02\u55ae (APIService: ",(0,t.jsx)(n.code,{children:"CreateOrder"}),")","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u5efa\u7acb",(0,t.jsx)(n.code,{children:"AtmAccountMessage"}),"\u985e\u5225\u7269\u4ef6 (\u7e7c\u627f\u81f3",(0,t.jsx)(n.code,{children:"ApiMessage"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["\u57f7\u884c",(0,t.jsx)(n.code,{children:"set_shop_data()"}),"\u8a2d\u5b9a\u8a02\u55ae\u76f8\u95dc\u8cc7\u6599","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u63d0\u4f9b",(0,t.jsx)(n.code,{children:"BackendURL"}),"\u7db2\u5740\u4f5c\u70baWebhook\uff0c\u8b93\u6c38\u8c50API\u4e4b\u5f8c\u547c\u53eb\u56de\u50b3",(0,t.jsx)(n.code,{children:"PayToken"})," (",(0,t.jsx)(n.code,{children:"/order/get_pay_token"}),")"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u57f7\u884c",(0,t.jsx)(n.code,{children:"create_new_order()"}),"\u65b9\u6cd5\u9032\u884c\u5404\u7a2e\u6240\u9700\u6d41\u7a0b\u4e4b\u8cc7\u6599\u6e96\u5099(\u52a0\u5bc6\u3001\u904b\u7b97\u7c3d\u7ae0\u7b49)\uff0c\u6700\u5f8c\u53eb\u7528API"]}),"\n",(0,t.jsxs)(n.li,{children:["\u4ee5",(0,t.jsx)(n.code,{children:"ResponseATM"}),"\u985e\u5225\u7269\u4ef6\u53d6\u56de\u56de\u50b3\u503c (\u7e7c\u627f\u81f3",(0,t.jsx)(n.code,{children:"ResponseMessage"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"\u66f4\u65b0Payment Model ORM\u7269\u4ef6 \u2192 \u81ea\u52d5\u66f4\u65b0\u8cc7\u6599\u5eab"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.p,{children:["\u2191\u2197\u2192\u2198\u2193\u2199\u2190\u2196\u2191\u2197\u2192\u2198\u2193\u2199\u2190\u2196\u2191\u2197\u2192\u2198\u2193\u2199\u2190\u2196\u2191\u2197\u2192\u2198\u2193\u2199\u2190\u2196\u2191\n\u7b49\u5f85",(0,t.jsx)(n.code,{children:"/order/get_pay_token"}),"\u88ab\u6c38\u8c50API\u547c\u53eb (\u5341\u5206\u9418\u5167)\n\u2191\u2197\u2192\u2198\u2193\u2199\u2190\u2196\u2191\u2197\u2192\u2198\u2193\u2199\u2190\u2196\u2191\u2197\u2192\u2198\u2193\u2199\u2190\u2196\u2191\u2197\u2192\u2198\u2193\u2199\u2190\u2196\u2191"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["[View] \u65bcBackendURL\u6536\u5230API\u7684PayToken (",(0,t.jsx)(n.code,{children:"/order/get_pay_token"}),")","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u547c\u53ebModel\u76f8\u5c0d\u7684",(0,t.jsx)(n.code,{children:"update_order_by_paytoken()"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["[Model] \u5305\u88ddPayToken\u9032\u884cAPI\u547c\u53eb (APIService: ",(0,t.jsx)(n.code,{children:"OrderPayQuery"}),")","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u5efa\u7acb",(0,t.jsx)(n.code,{children:"QueryByPaytokenMessage"}),"\u985e\u5225\u7269\u4ef6 (\u7e7c\u627f\u81f3",(0,t.jsx)(n.code,{children:"ApiMessage"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["\u57f7\u884c",(0,t.jsx)(n.code,{children:"set_paytoken_json()"}),"\u8a2d\u5b9aPayToken\u6240\u9700\u76f8\u95dc\u8cc7\u6599"]}),"\n",(0,t.jsxs)(n.li,{children:["\u57f7\u884c",(0,t.jsx)(n.code,{children:"send_query()"}),"\u65b9\u6cd5\u9032\u884c\u5404\u7a2e\u6240\u9700\u6d41\u7a0b\u4e4b\u8cc7\u6599\u6e96\u5099(\u52a0\u5bc6\u3001\u904b\u7b97\u7c3d\u7ae0\u7b49)\uff0c\u6700\u5f8c\u53eb\u7528API"]}),"\n",(0,t.jsxs)(n.li,{children:["\u4ee5",(0,t.jsx)(n.code,{children:"ResponsePayToken"}),"\u985e\u5225\u7269\u4ef6\u53d6\u56de\u56de\u50b3\u503c (\u7e7c\u627f\u81f3",(0,t.jsx)(n.code,{children:"ResponseMessage"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"\u53d6\u51faPayToken\u554f\u56de\u7684\u8a02\u55ae\uff0c\u5c07\u4ed8\u6b3e\u72c0\u614b\u5beb\u56dePayment Model ORM\u7269\u4ef6 \u2192 \u81ea\u52d5\u66f4\u65b0\u8cc7\u6599\u5eab"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"\u7269\u4ef6\u5c0e\u5411\u985e\u5225\u898f\u5283",children:"\u7269\u4ef6\u5c0e\u5411\u985e\u5225\u898f\u5283"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354pB6yTW2aZF.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354pB6yTW2aZF.png"})}),"\n",(0,t.jsx)(n.p,{children:"\u7531\u4ee5\u4e0a\u53ef\u4ee5\u770b\u51fa\uff0c\u7121\u8ad6\u662fATM\u7684\u6d41\u7a0b\uff0c\u6216\u662fPayToken\u7684\u6d41\u7a0b\u90fd\u6709\u76f8\u4f3c\u7684\u904b\u4f5c\u57fa\u5e95\uff0c\u56e0\u6b64\u6211\u6703\u5be6\u4f5c\u5e7e\u500b\u4e3b\u8981\u7684\u985e\u5225\uff1a"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\u901a\u7528\u5de5\u5177class ",(0,t.jsx)(n.code,{children:"SinopacUtil"}),"\uff1a\u542b\u53d6\u5f97nonce\u3001\u8a08\u7b97hash_id\u3001AES\u52a0\u5bc6\u3001\u7522\u751f\u5b89\u5168\u7c3d\u7ae0\u7b49\u65b9\u6cd5"]}),"\n",(0,t.jsxs)(n.li,{children:["\u5171\u540c\u7236\u985e\u5225\uff1a","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["class ",(0,t.jsx)(n.code,{children:"ApiMessage"}),"\uff1a\u7121\u95dc\u54ea\u4e00\u7a2eAPI\u53eb\u7528\u6240\u9700\u7684\u5167\u5bb9\u8207\u6d41\u7a0b"]}),"\n",(0,t.jsxs)(n.li,{children:["class ",(0,t.jsx)(n.code,{children:"ResponseMessage"}),"\uff1a\u7121\u95dc\u4e00\u7a2eAPI\u53eb\u7528\u5f8c\u53d6\u5f97response\u5167\u5bb9\u8207\u6d41\u7a0b\u7684\u57fa\u790e (AES\u89e3\u5bc6)"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u660e\u78ba\u61c9\u7528\u5b50\u985e\u5225\uff1a","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["[ApiMessage] sub-class ",(0,t.jsx)(n.code,{children:"AtmAccountMessage"}),"\uff1a\u547c\u53eb\u5efa\u7acbATM\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u4e4b\u8a02\u55aeAPI\u8a0a\u606f\u547c\u53eb\uff0c\u76f8\u95dc\u7684\u53c3\u6578\u9700\u8a2d\u5b9a\uff0c\u4f8b\u5982\u7e3d\u91d1\u984d\u3001\u4ed8\u6b3e\u65b9\u5f0f\u3001\u662f\u5426\u6a21\u64ec\u4ed8\u6b3e\u3001\u6700\u5f8c\u4ed8\u6b3e\u65e5\u671f\u2026\u7b49\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:["[ApiMessage] sub-class ",(0,t.jsx)(n.code,{children:"QueryByPaytokenMessage"}),"\uff1a\u547c\u53eb\u4ee5PayToken\u67e5\u8a62\u76f8\u95dc\u4ed8\u6b3e\u8cc7\u8a0a\u7684API\u8a0a\u606f\u547c\u53eb\uff0c\u76f8\u95dc\u7684\u53c3\u6578\u9700\u8a2d\u5b9a\u70baPayToken\u8207ShopNo\u4e4bJSON\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:["[ResponseMessage] sub-class ",(0,t.jsx)(n.code,{children:"AtmAccountMessage"}),"\uff1a\u53d6\u5f97\u6709\u95dc\u6210\u529f\u5efa\u7acbATM\u8a02\u55ae\u5f8c\u7684\u56de\u50b3\u503c\u89e3\u5bc6\u7d50\u679c\uff0c\u5176\u5c6c\u6027\u662f\u70ba\u4e86\u5efa\u7acbPayment Table\u7528\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:["[ResponseMessage] sub-class ",(0,t.jsx)(n.code,{children:"ResponsePayToken"}),"\uff1a\u53d6\u5f97\u6709\u95dc\u6210\u529f\u4ee5PayToken\u67e5\u8a62\u5f8c\u7684\u56de\u50b3\u503c\u89e3\u5bc6\u7d50\u679c\uff0c\u5176\u5c6c\u6027\u662f\u70ba\u4e86\u66f4\u65b0",(0,t.jsx)(n.strong,{children:"\u4ed8\u6b3e\u72c0\u614b"}),"\u81f3Payment Table\u7528\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"\u7a0b\u5f0f\u78bc\u96c6\u5408",children:"\u7a0b\u5f0f\u78bc\u96c6\u5408"}),"\n",(0,t.jsx)(n.p,{children:"\u4ee5\u4e0a\u5148\u628a\u4e0a\u9762\u9019\u5e7e\u6bb5Code\u5206\u4eab\u5b8c\u6574\u5167\u5bb9\uff0c\u4f46\u90e8\u4efd\u5be6\u4f5c\u5148\u524d\u6587\u7ae0\u5df2\u8aaa\u660e\u5c31\u4e0d\u518d\u8a73\u8ff0"}),"\n",(0,t.jsx)(n.h4,{id:"\u901a\u7528\u5de5\u5177class-sinopacutil",children:"\u901a\u7528\u5de5\u5177class SinopacUtil"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'class SinopacUtil:\n    # \u7121\u8ad6ATM\u6216\u4fe1\u7528\u5361\u90fd\u6703\u7528\u5230\n    backend_url = "https://kummyshop.herokuapp.com/order/get_pay_token"\n\n    @staticmethod\n    def bytes_xor_to_hexstring(ba1, ba2):\n        return bytes([a ^ b for a, b in zip(ba1, ba2)]).hex()\n\n    @staticmethod\n    def get_hash_id(A1, A2, B1, B2):\n        ba_xor_A = SinopacUtil.bytes_xor_to_hexstring(bytes.fromhex(A1), bytes.fromhex(A2))\n        ba_xor_B = SinopacUtil.bytes_xor_to_hexstring(bytes.fromhex(B1), bytes.fromhex(B2))\n        return "{}{}".format(ba_xor_A, ba_xor_B).upper()\n\n    @staticmethod\n    def gen_order_no(will_paid=True):\n        today = date.today()\n        year = today.year\n        month = today.month\n\n        order_no = "A{}{:02}{}".format(year, month, SinopacUtil.get_rand_part_str(will_paid))\n        return order_no\n\n    @staticmethod\n    def get_aes_iv(nonce):\n        return hashlib.sha256(nonce.encode(\'UTF-8\')).hexdigest().upper()[-16:]\n\n    @staticmethod\n    def get_new_nonce(shop_no):\n        url = "https://sandbox.sinopac.com/QPay.WebAPI/api/Nonce"\n        req_param = {\n            "ShopNo": shop_no\n        }\n        response = requests.post(url=url, json=req_param).json()\n        return str(response["Nonce"])\n\n    @staticmethod\n    def get_message(ori_shop_data, hash_id, iv):\n        hash_id_ba = bytes(hash_id, \'utf-8\')\n        print("- hash_id_ba: {}".format(hash_id_ba))\n\n        iv_ba = bytes(iv, \'utf-8\')\n        print("- iv_ba: {}".format(iv_ba))\n\n        data_string = json.dumps(ori_shop_data, ensure_ascii=False, separators=(\',\', \':\'))\n        print(data_string)\n\n        print("-- len of AES key: {}".format(len(hash_id_ba)))\n        cipher = AES.new(key=hash_id_ba, mode=AES.MODE_CBC, iv=iv_ba)\n        message = cipher.encrypt(pad(bytes(data_string, \'utf-8\'), AES.block_size))\n        return message.hex().upper()\n\n    @staticmethod\n    def get_sign(ori_shop_data, hash_id, nonce):\n        sorted_shop_data = {key: ori_shop_data.get(key) for key in sorted(ori_shop_data.keys(), key=str.casefold)}\n        print("* sorted_shop_data: {}".format(sorted_shop_data))\n\n        removed_rule_values_shop_data = {key: value for key, value in sorted_shop_data.items() if\n                                         SinopacUtil.check_passed_rule_param(value)}\n        print("* removed_rule_values_shop_data: {}".format(removed_rule_values_shop_data))\n\n        url_param = urllib.parse.urlencode(removed_rule_values_shop_data)\n        print("* url_param: {}".format(url_param))\n\n        url_param_no_percent_encode = urllib.parse.unquote(url_param).replace("+", " ")\n        print("- url_param_no_percent_encode: {}".format(url_param_no_percent_encode))\n\n        final_shop_data = "{}{}{}".format(url_param_no_percent_encode, nonce, hash_id)\n        print("- final_shop_data: {}".format(final_shop_data))\n\n        sign = hashlib.sha256(final_shop_data.encode(\'UTF-8\')).hexdigest().upper()\n        print("- sign: {}".format(sign))\n        return sign\n\n\n    @staticmethod\n    def check_passed_rule_param(value):\n        if value is None:\n            return False\n        elif type(value) is dict or type(value) is list:\n            return False\n        elif type(value) is str and not value.strip():\n            return False\n        else:\n            return True\n\n    @staticmethod\n    def get_rand_part_str(will_paid):\n        rand_part = 9\n        gen_digit = 6\n\n        if will_paid:\n            while rand_part % 10 == 9:\n                rand_part = randrange(0, 10 ** ((gen_digit - 1) + 1))\n        else:\n            rand_part = randrange(0, 10 ** (gen_digit - 1)) * 10 + 9\n        return "{:000006}".format(rand_part)\n'})}),"\n",(0,t.jsx)(n.h4,{id:"\u5171\u540c\u7236\u985e\u5225class-apimessage",children:"\u5171\u540c\u7236\u985e\u5225class ApiMessage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'class ApiMessage:\n    shop_no = "NA0249_001"\n    api_url = "https://sandbox.sinopac.com/QPay.WebAPI/api/Order"\n    A1, A2, B1, B2 = "86D50DEF3EB7400E", "01FD27C09E5549E5", "9E004965F4244953", "7FB3385F414E4F91"\n\n    def __init__(self, api_service):\n\n        self.hash_id = SinopacUtil.get_hash_id(ApiMessage.A1, ApiMessage.A2, ApiMessage.B1, ApiMessage.B2)\n        self.nonce = SinopacUtil.get_new_nonce(ApiMessage.shop_no)\n        print("Nonce: " + self.nonce)\n        self.iv = SinopacUtil.get_aes_iv(self.nonce)\n        print("IV: " + self.iv)\n\n        self.api_service = api_service\n        self.api_base_param = {\n            "Version": "1.0.0",\n            "ShopNo": ApiMessage.shop_no,\n            "APIService": api_service,\n            "Sign": "",\n            "Nonce": self.nonce,\n            "Message": ""\n        }\n        self.plain_message = None\n        self.msg = None\n        self.sign = None\n\n    def _set_plain_msg_to_proc_msg_sign(self, plain_message):\n        self.plain_message = plain_message\n\n        # AES encryption for Message\n        self.msg = SinopacUtil.get_message(self.plain_message, self.hash_id, self.iv)\n        print("- msg: " + self.msg)\n        self.api_base_param["Message"] = self.msg\n\n        # SHA-256 for Sign\n        self.sign = SinopacUtil.get_sign(self.plain_message, self.hash_id, self.nonce)\n        print("- sign in SHA256: " + self.sign)\n        self.api_base_param["Sign"] = self.sign\n\n    def _send_api(self):\n        print("-- Final request: " + json.dumps(self.api_base_param))\n        response = requests.post(url=self.api_url, json=self.api_base_param).json()\n        print("-- Final Response: " + json.dumps(response))\n        return response\n\n    @staticmethod\n    def _gen_temp_shop_data():\n        tmp_data = {\n            "ShopNo": "",\n            "OrderNo": "",\n            "Amount": 0,\n            "CurrencyID": "TWD",\n            "PayType": "",\n            "ATMParam": {},\n            "CardParam": {},\n            "PrdtName": "",\n            "ReturnURL": "",\n            "BackendURL": ""\n        }\n        return tmp_data        \n'})}),"\n",(0,t.jsx)(n.h4,{id:"\u5efa\u7acbatm\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u4e4b\u8a02\u55ae\u985e\u5225atmaccountmessage",children:"\u5efa\u7acbATM\u865b\u64ec\u5e33\u6236\u4ed8\u6b3e\u4e4b\u8a02\u55ae\u985e\u5225AtmAccountMessage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'class AtmAccountMessage(ApiMessage):\n    return_url = "https://kummyshop.herokuapp.com/order/return"\n\n    def __init__(self):\n        super().__init__("OrderCreate")\n        self.shop_data = None\n\n    def set_shop_data(self, will_paid=True, amount=100, expire_days=10):\n        self.shop_data = AtmAccountMessage.gen_default_shop_data(self.shop_no, will_paid, amount)\n        self.shop_data["PayType"] = "A"\n        self.shop_data["ATMParam"]["ExpireDate"] = AtmAccountMessage.gen_expire_date(expire_days)\n        self.shop_data["ReturnURL"] = AtmAccountMessage.return_url\n        self.shop_data["BackendURL"] = SinopacUtil.backend_url\n        print("- shop_data: {}".format(self.shop_data))\n        super()._set_plain_msg_to_proc_msg_sign(self.shop_data)\n\n    def create_new_order(self):\n        print("Send API...")\n        return super()._send_api()\n\n    @staticmethod\n    def gen_default_shop_data(shop_no, will_paid=True, amount=100):\n        tmp_data = ApiMessage._gen_temp_shop_data()\n        tmp_data["ShopNo"] = shop_no\n        tmp_data["OrderNo"] = SinopacUtil.gen_order_no(will_paid)\n        tmp_data["Amount"] = amount * 100\n        tmp_data["PrdtName"] = "\u865b\u64ec\u5e33\u865f\u8a02\u55ae"\n\n        return tmp_data\n\n    @staticmethod\n    def gen_expire_date(days=10):\n        expire_date = datetime.now() + timedelta(days=days)\n        return expire_date.strftime("%Y%m%d")\n'})}),"\n",(0,t.jsx)(n.h4,{id:"\u4ee5paytoken\u67e5\u8a62\u76f8\u95dc\u4ed8\u6b3e\u8cc7\u8a0a\u985e\u5225querybypaytokenmessage",children:"\u4ee5PayToken\u67e5\u8a62\u76f8\u95dc\u4ed8\u6b3e\u8cc7\u8a0a\u985e\u5225QueryByPaytokenMessage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'class QueryByPaytokenMessage(ApiMessage):\n    def __init__(self):\n        super().__init__("OrderPayQuery")\n        self.paytoken_json = None\n\n    def set_paytoken_json(self, paytoken_json):\n        self.paytoken_json = paytoken_json\n        print("- paytoken_json: {}".format(self.paytoken_json))\n        super()._set_plain_msg_to_proc_msg_sign(self.paytoken_json)\n\n    def send_query(self):\n        print("Send API...")\n        return super()._send_api()\n'})}),"\n",(0,t.jsx)(n.h4,{id:"\u5171\u540c\u7236\u985e\u5225class-responsemessage",children:"\u5171\u540c\u7236\u985e\u5225class ResponseMessage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'class ResponseMessage:\n    def __init__(self, resp_json, hash_id):\n        self.hash_id = hash_id\n        self.resp_json = resp_json\n        self.resp_nonce = resp_json["Nonce"]\n        self.resp_msg = resp_json["Message"]\n        self.resp_ori_sign = resp_json["Sign"]\n        self.dec_resp_json = self.__msg_dec()\n\n    def __msg_dec(self):\n        dec = ResponseMessage.aes_dec(self.resp_msg, self.resp_nonce, self.hash_id)\n        print("- Decryption of Response: {}".format(dec))\n        dec_resp_json = json.loads(dec)\n\n        resp_gen_sign = SinopacUtil.get_sign(dec_resp_json, self.hash_id, self.resp_nonce)\n        print("- \u91cd\u65b0\u7522\u751fSign\u503c: {}".format(resp_gen_sign))\n        return dec_resp_json\n\n\n    @staticmethod\n    def aes_dec(data_string, resp_nonce, hash_id):\n        hash_id_ba = hash_id.encode("utf-8")\n        iv_ba = SinopacUtil.get_aes_iv(resp_nonce).encode("utf-8")\n        cipher = AES.new(key=hash_id_ba, mode=AES.MODE_CBC, iv=iv_ba)\n        message = bytes.decode(unpad(cipher.decrypt(bytes.fromhex(data_string)), AES.block_size), "utf-8")\n        return message\n'})}),"\n",(0,t.jsx)(n.h4,{id:"atm\u67e5\u8a62\u7d50\u679c\u985e\u5225responseatm",children:"ATM\u67e5\u8a62\u7d50\u679c\u985e\u5225ResponseATM"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'class ResponseATM(ResponseMessage):\n    def __init__(self, resp_json, hash_id):\n        super().__init__(resp_json, hash_id)\n\n        self.orderno = self.dec_resp_json["OrderNo"]\n        self.amount = self.dec_resp_json["Amount"]\n        self.tsno = self.dec_resp_json["TSNo"]\n        self.status = self.dec_resp_json["Status"]\n        self.desc = self.dec_resp_json["Description"]\n        self.atm_param = self.dec_resp_json["ATMParam"]\n        self.atm_pay_no = self.atm_param["AtmPayNo"]\n        self.web_atm_url = self.atm_param["WebAtmURL"]\n        self.otp_url = self.atm_param["OtpURL"]\n'})}),"\n",(0,t.jsx)(n.h4,{id:"\u4ee5paytoken\u67e5\u8a62\u5b8c\u7684\u4ed8\u6b3e\u8cc7\u8a0a\u7d50\u679c\u985e\u5225responsepaytoken",children:"\u4ee5PayToken\u67e5\u8a62\u5b8c\u7684\u4ed8\u6b3e\u8cc7\u8a0a\u7d50\u679c\u985e\u5225ResponsePayToken"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'class ResponsePayToken(ResponseMessage):\n    def __init__(self, resp_json, hash_id):\n        super().__init__(resp_json, hash_id)\n\n        self.paytoken = self.dec_resp_json["PayToken"]\n        self.tsresult = self.dec_resp_json["TSResultContent"]\n        self.orderno = self.tsresult["OrderNo"]\n        self.tsno = self.tsresult["TSNo"]\n        self.status = self.tsresult["Status"]\n        self.aptype = self.tsresult["APType"]\n        self.paydate = self.tsresult["PayDate"]\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u7d50\u679c\u9a57\u8b49",children:"\u7d50\u679c\u9a57\u8b49"}),"\n",(0,t.jsx)(n.p,{children:"\u5f85\u6211\u5011\u628a\u6240\u6709\u7684Code\u90fd\u66f4\u65b0\u4e0aHeroku\u5f8c\uff0c\u78ba\u6700\u6700\u5f8c\u7684\u4f48\u7f72\u8a0a\u606fVerifying deploy... done.\u5f8c\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u770b\u4e00\u4e0b\uff0c\u57f7\u884c\u7684\u7d50\u679c\u4e86\u3002"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354zpWS8WfhC8.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354zpWS8WfhC8.png"})}),"\n",(0,t.jsx)(n.h4,{id:"step1-\u5728view\u4e2d\u57f7\u884c\u5efa\u7acb\u65b0\u55ae",children:"STEP1: \u5728View\u4e2d\u57f7\u884c\u5efa\u7acb\u65b0\u55ae"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354uzrBcWm3RC.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354uzrBcWm3RC.png"})}),"\n",(0,t.jsx)(n.h4,{id:"step2-\u67e5\u8a62\u76ee\u524d\u8cc7\u6599\u5eab\u72c0\u614b\u65b0\u8a02\u55ae\u8cc7\u6599\u9032\u4f86\u4e86",children:"STEP2: \u67e5\u8a62\u76ee\u524d\u8cc7\u6599\u5eab\u72c0\u614b\uff0c\u65b0\u8a02\u55ae\u8cc7\u6599\u9032\u4f86\u4e86"}),"\n",(0,t.jsxs)(n.p,{children:["\u76f4\u63a5\u5728pgAdmin\u4e2d\u67e5\u8a62\u6700\u65b0\u8cc7\u6599\uff0c\u6700\u4e0a\u65b9\u9019\u7b46\u8cc7\u6599\u5c31\u662f\u6211\u5011\u7b49\u5f85\u88ab\u6c38\u8c50API\u547c\u53ebBackendURL\u5f8c\u66f4\u65b0\u7684\u8cc7\u6599\uff0c\u76ee\u524d\u72c0\u614b\u4ecd\u7136\u662f\u5728\u7b49\u5f85\u4e2d\u3002\n",(0,t.jsx)(n.img,{src:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354WRX2mk00VI.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354WRX2mk00VI.png"})]}),"\n",(0,t.jsx)(n.h4,{id:"step3-backendurl\u88ab\u547c\u53eb\u66f4\u65b0\u8cc7\u6599\u5eab\u4ed8\u6b3e\u72c0\u614b",children:"STEP3: BackendURL\u88ab\u547c\u53eb\uff0c\u66f4\u65b0\u8cc7\u6599\u5eab\u4ed8\u6b3e\u72c0\u614b"}),"\n",(0,t.jsx)(n.p,{children:"PayToken\u6240\u67e5\u8a62\u5230\u7684\u56de\u50b3\u7d50\u679c\u89e3\u5bc6response\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'{\n   "ShopNo":"NA0249_001",\n   "PayToken":"8ab3058e04bd1a58b54232987530c4faa6e97be7b1de009c1d230f125c7802c9",\n   "Date":"202110022135",\n   "Status":"S",\n   "Description":"S0000 \u2013 \u8655\u7406\u6210\u529f",\n   "TSResultContent":{\n      "APType":"PayOut",\n      "TSNo":"NA024900000479",\n      "OrderNo":"A202110235940",\n      "ShopNo":"NA0249_001",\n      "PayType":"A",\n      "Amount":"9440300",\n      "Status":"S",\n      "Description":"",\n      "PayDate":"202110022130"\n   }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u6700\u5f8c\u518d\u78ba\u8a8d\u8cc7\u6599\u5eab\u7684\u66f4\u65b0\u72c0\u614b\uff1a\n",(0,t.jsx)(n.img,{src:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354pWOcr2vuOm.png",alt:"https://ithelp.ithome.com.tw/upload/images/20211002/20130354pWOcr2vuOm.png"})]}),"\n",(0,t.jsxs)(n.p,{children:["\u6c92\u932f\uff0c\u5927\u5e2b\u5144\u56de\u4f86\u4e86\uff01\u597d\u611f\u4eba\uff01\n\u592a\u68d2\u4e86\uff01\u9019\u4e00\u523b\u7b49\u4e86\u597d\u4e45\u5440\uff0c\u62cd\u5f35\u7167\u7247\u8a18\u9304\u4e00\u4e0b\uff01\n",(0,t.jsx)(n.img,{src:"https://ithelp.ithome.com.tw/images/emoticon/emoticon74.gif",alt:"/images/emoticon/emoticon74.gif"})]})]})}function _(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>i});var a=s(6540);const t={},o=a.createContext(t);function r(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);